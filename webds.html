<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>フラッシュ暗算 トレーナー</title>
<style>
  :root{
    --bg:#0f172a;        /* slate-900 */
    --panel:#111827;     /* gray-900 */
    --ink:#e5e7eb;       /* gray-200 */
    --muted:#94a3b8;     /* slate-400 */
    --accent:#22d3ee;    /* cyan-400 */
    --good:#22c55e;      /* green-500 */
    --bad:#ef4444;       /* red-500 */
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    display:flex; min-height:100svh; align-items:center; justify-content:center; padding:24px;
  }
  .app{
    width:min(100%,980px); background:linear-gradient(180deg, #0b1224 0%, #0b1224 50%, #0e162b 100%);
    border:1px solid #1f2937; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    overflow:hidden;
  }
  header{display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #1f2937}
  header h1{margin:0; font-size:20px; letter-spacing:.04em}
  header .hint{color:var(--muted); font-size:12px}
  main{display:grid; grid-template-columns: 320px 1fr; gap:0; }
  @media (max-width:900px){ main{grid-template-columns:1fr} }

  /* 左ペイン（設定） */
  .panel{
    border-right:1px solid #1f2937; padding:18px; background:var(--panel);
  }
  .group{margin-bottom:14px}
  .group label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
  .row{display:flex; gap:10px}
  .row > *{flex:1}
  input[type="number"], select, input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid #1f2937; background:#0b1224; color:var(--ink);
    border-radius:10px; outline:none; font-size:14px;
  }
  input[type="checkbox"]{transform:scale(1.05); margin-right:6px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; background:var(--accent); color:#082f34; font-weight:700; border:0; border-radius:12px;
    cursor:pointer; width:100%; transition:transform .06s ease, filter .2s ease;
  }
  .btn:disabled{opacity:.45; cursor:not-allowed; filter:saturate(.2)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#1f2937; color:var(--ink); border:1px solid #334155}

  /* 右ペイン（表示） */
  .stage{
    position:relative; display:flex; flex-direction:column; gap:12px; padding:18px;
  }
  .display{
    flex:1; display:grid; place-items:center; border:1px dashed #233149; border-radius:16px; background:radial-gradient(80% 80% at 50% 40%, rgba(34,211,238,.08), transparent 70%);
    min-height:280px;
  }
  .big{
    font-variant-numeric:tabular-nums; font-weight:800; line-height:1; letter-spacing:.02em;
    font-size: clamp(56px, 9vw, 120px); text-shadow:0 6px 22px rgba(34,211,238,.25);
  }
  .faint{opacity:.25}
  .status{display:flex; flex-wrap:wrap; gap:10px; color:var(--muted); font-size:13px}
  .pill{background:#0b1224; border:1px solid #1f2937; padding:6px 10px; border-radius:999px}
  .answer-wrap{display:flex; gap:10px}
  .answer-wrap input{
    flex:1; font-size:20px; padding:12px 14px; border-radius:12px; border:1px solid #1f2937; background:#0b1224; color:var(--ink);
  }
  .result{
    border:1px solid #1f2937; border-radius:14px; padding:12px 14px; background:#0b1224; display:none;
  }
  .result.ok{border-color:rgba(34,197,94,.5)}
  .result.ng{border-color:rgba(239,68,68,.5)}
  .history{margin-top:8px; color:var(--muted); font-size:12px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; background:#0b1224; border:1px solid #334155; border-radius:6px; padding:1px 6px}
  footer{padding:12px 18px; color:var(--muted); font-size:12px; border-top:1px solid #1f2937}
  a{color:var(--accent); text-decoration:none}
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>フラッシュ暗算 トレーナー</h1>
      <div class="hint">ショートカット：<span class="kbd">S</span>開始 / <span class="kbd">Enter</span>解答 / <span class="kbd">Esc</span>リセット</div>
    </header>

    <main>
      <!-- 左：設定 -->
      <section class="panel">
        <div class="group">
          <label>モード</label>
          <select id="mode">
            <option value="add" selected>足し算（正の整数）</option>
            <option value="mix">足し算（ときどき減算を混ぜる）</option>
          </select>
        </div>

        <div class="group row">
          <div>
            <label>桁数（各数）</label>
            <select id="digits">
              <option value="1">1 桁</option>
              <option value="2" selected>2 桁</option>
              <option value="3">3 桁</option>
              <option value="4">4 桁</option>
            </select>
          </div>
          <div>
            <label>個数（表示回数）</label>
            <input type="number" id="count" min="2" max="50" value="10" />
          </div>
        </div>

        <div class="group row">
          <div>
            <label>表示速度（ms/枚）</label>
            <input type="number" id="speed" min="100" step="50" value="600" />
          </div>
          <div>
            <label>ブランク時間（ms）</label>
            <input type="number" id="gap" min="0" step="50" value="150" />
          </div>
        </div>

        <div class="group">
          <label><input type="checkbox" id="voice"> 読み上げ（ブラウザ音声）</label>
          <label><input type="checkbox" id="showProgress" checked> 進捗を表示</label>
          <label><input type="checkbox" id="shuffleSign"> 減算を最大 30% 混ぜる（モード「mix」用）</label>
        </div>

        <div class="group row">
          <button class="btn" id="startBtn">▶ 開始</button>
          <button class="btn secondary" id="resetBtn">⟲ リセット</button>
        </div>

        <div class="group">
          <label>記録</label>
          <div class="history" id="best">最短解答時間：— / 連続正解：0</div>
        </div>
      </section>

      <!-- 右：表示＆解答 -->
      <section class="stage">
        <div class="display">
          <div id="number" class="big faint">準備OK</div>
        </div>

        <div class="status" id="statusBar">
          <div class="pill" id="progress">0 / 0</div>
          <div class="pill">合計：<span id="running">—</span></div>
          <div class="pill">所要：<span id="elapsed">0.00s</span></div>
        </div>

        <div class="answer-wrap">
          <input id="answer" inputmode="numeric" pattern="[0-9\-]*" placeholder="合計を入力（Enterで判定）" autocomplete="off" disabled />
          <button class="btn" id="submitBtn" disabled>✔ 判定</button>
        </div>

        <div class="result" id="resultBox"></div>
        <div class="history" id="lastProblems"></div>
      </section>
    </main>

    <footer>
      作成者：あなた（このページはローカルで完結します）｜ヒント：練習は「桁は固定・個数は短め・速度はやや速め」から始めると集中が切れにくいです。
    </footer>
  </div>

<script>
(() => {
  const el = id => document.getElementById(id);

  // UI 参照
  const numberEl = el('number');
  const progressEl = el('progress');
  const runningEl  = el('running');
  const elapsedEl  = el('elapsed');
  const resultBox  = el('resultBox');
  const answerIn   = el('answer');
  const submitBtn  = el('submitBtn');
  const startBtn   = el('startBtn');
  const resetBtn   = el('resetBtn');
  const bestEl     = el('best');
  const lastProblems = el('lastProblems');

  // 設定
  const modeSel   = el('mode');
  const digitsSel = el('digits');
  const countIn   = el('count');
  const speedIn   = el('speed');
  const gapIn     = el('gap');
  const voiceChk  = el('voice');
  const showProg  = el('showProgress');
  const shuffleSign = el('shuffleSign');

  // 状態
  let running = false;
  let abortFlag = false;
  let seq = [];
  let correctSum = 0;
  let startTime = 0;
  let answerPhase = false;

  // 記録
  const store = {
    bestMs: null,
    streak: 0,
    last: []  // 直近 5 問
  };

  function rngInt(min, max){ // inclusive
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function makeSequence(){
    const digits = parseInt(digitsSel.value,10);
    const count  = clamp(parseInt(countIn.value,10), 2, 50);
    const min = digits === 1 ? 1 : Math.pow(10, digits - 1);
    const max = Math.pow(10, digits) - 1;

    const useMix = modeSel.value === 'mix';
    const allowMinus = useMix && shuffleSign.checked;
    const seq = [];
    for(let i=0;i<count;i++){
      let n = rngInt(min, max);
      if(allowMinus){
        // 0〜0.3の確率で減算（負号を付与）
        if(Math.random() < 0.30) n = -n;
      }
      seq.push(n);
    }
    return seq;
  }

  function speak(text){
    if(!voiceChk.checked) return;
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = 'ja-JP';
    u.rate = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  function setRunningSumVisible(flag){
    document.querySelectorAll('.pill')[1].
